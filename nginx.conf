# =============================================================================
# Proxy CORS autonome pour gouv-widgets
# =============================================================================
#
# Ce fichier configure un reverse proxy Nginx dont le seul role est de
# contourner les restrictions CORS des APIs externes utilisees par les
# composants gouv-widgets.
#
# Routes :
#   /grist-proxy/      -> https://docs.getgrist.com/
#   /grist-gouv-proxy/ -> https://grist.numerique.gouv.fr/
#   /albert-proxy/     -> https://albert.api.etalab.gouv.fr/
#   /tabular-proxy/    -> https://tabular-api.data.gouv.fr/
#
# Aucun fichier statique n'est servi. Ce proxy peut etre deploye
# independamment de l'application frontend.
# =============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 1024;
}

http {
    # -------------------------------------------------------------------------
    # Parametres generaux
    # -------------------------------------------------------------------------
    log_format main '$remote_addr - $remote_user [$time_local] '
                    '"$request" $status $body_bytes_sent '
                    '"$http_referer" "$http_user_agent"';

    log_format beacon '$time_iso8601|$http_referer|$arg_c|$arg_t|$remote_addr|$arg_r';

    access_log /var/log/nginx/access.log main;

    sendfile        on;
    tcp_nopush      on;
    tcp_nodelay     on;
    keepalive_timeout 65;

    # Resolvers DNS necessaires pour les proxy_pass vers des noms de domaine.
    # 8.8.8.8 = Google DNS, 1.1.1.1 = Cloudflare DNS.
    # Adapter si vous utilisez un resolver interne.
    resolver 8.8.8.8 1.1.1.1 valid=300s;
    resolver_timeout 5s;

    # -------------------------------------------------------------------------
    # Serveur proxy
    # -------------------------------------------------------------------------
    server {
        listen 80;
        server_name _;

        # En-tetes de securite globaux
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;

        # -----------------------------------------------------------------
        # Health check minimal
        # -----------------------------------------------------------------
        location = /health {
            access_log off;
            return 200 '{"status":"ok"}';
            add_header Content-Type application/json;
        }

        # -----------------------------------------------------------------
        # Beacon de tracking des widgets deployes
        # -----------------------------------------------------------------
        location = /beacon {
            access_log /var/log/nginx/beacon.log beacon;
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Cache-Control' 'no-store' always;
            return 204;
        }

        # =================================================================
        # Proxy : Grist (docs.getgrist.com)
        # =================================================================
        location /grist-proxy/ {
            # -- Preflight OPTIONS ----------------------------------------
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                add_header 'Content-Type' 'text/plain; charset=UTF-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Masquer les headers CORS de l'upstream pour eviter les doublons
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';

            # -- CORS pour les requetes normales --------------------------
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
            add_header 'Access-Control-Max-Age' 86400 always;

            # -- Proxy vers l'upstream ------------------------------------
            proxy_pass https://docs.getgrist.com/;
            proxy_ssl_server_name on;
            proxy_set_header Host docs.getgrist.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Desactiver le cache Nginx pour toujours relayer les donnees fraiches
            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }

        # =================================================================
        # Proxy : Grist Numerique Gouv (grist.numerique.gouv.fr)
        # =================================================================
        location /grist-gouv-proxy/ {
            # -- Preflight OPTIONS ----------------------------------------
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                add_header 'Content-Type' 'text/plain; charset=UTF-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Masquer les headers CORS de l'upstream pour eviter les doublons
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';

            # -- CORS pour les requetes normales --------------------------
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
            add_header 'Access-Control-Max-Age' 86400 always;

            # -- Proxy vers l'upstream ------------------------------------
            proxy_pass https://grist.numerique.gouv.fr/;
            proxy_ssl_server_name on;
            proxy_set_header Host grist.numerique.gouv.fr;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }

        # =================================================================
        # Proxy : Albert IA API (albert.api.etalab.gouv.fr)
        # =================================================================
        location /albert-proxy/ {
            # -- Preflight OPTIONS ----------------------------------------
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                add_header 'Content-Type' 'text/plain; charset=UTF-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Masquer les headers CORS de l'upstream pour eviter les doublons
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';

            # -- CORS pour les requetes normales --------------------------
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
            add_header 'Access-Control-Max-Age' 86400 always;

            # -- Proxy vers l'upstream ------------------------------------
            proxy_pass https://albert.api.etalab.gouv.fr/;
            proxy_ssl_server_name on;
            proxy_set_header Host albert.api.etalab.gouv.fr;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }

        # =================================================================
        # Proxy : Tabular API data.gouv.fr (tabular-api.data.gouv.fr)
        # =================================================================
        location /tabular-proxy/ {
            # -- Preflight OPTIONS ----------------------------------------
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
                add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
                add_header 'Access-Control-Max-Age' 86400 always;
                add_header 'Content-Type' 'text/plain; charset=UTF-8' always;
                add_header 'Content-Length' 0 always;
                return 204;
            }

            # Masquer les headers CORS de l'upstream pour eviter les doublons
            proxy_hide_header 'Access-Control-Allow-Origin';
            proxy_hide_header 'Access-Control-Allow-Methods';
            proxy_hide_header 'Access-Control-Allow-Headers';

            # -- CORS pour les requetes normales --------------------------
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' 'Origin, Content-Type, Accept, Authorization' always;
            add_header 'Access-Control-Max-Age' 86400 always;

            # -- Proxy vers l'upstream ------------------------------------
            proxy_pass https://tabular-api.data.gouv.fr/;
            proxy_ssl_server_name on;
            proxy_set_header Host tabular-api.data.gouv.fr;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            proxy_no_cache 1;
            proxy_cache_bypass 1;
        }

        # -----------------------------------------------------------------
        # Tout le reste -> 404
        # -----------------------------------------------------------------
        location / {
            return 404 '{"error":"route inconnue"}';
            add_header Content-Type application/json;
        }
    }
}
